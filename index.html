<!DOCTYPE html>
<html>
<head>
  <title>Kiki Learns to Read - Phoneme Blender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      max-width: 480px;
      margin: auto;
      background: #fff7ff;
    }
    h1, h2, h3 {
      text-align: center;
    }
    .mode-switch {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .mode-switch button {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      background: #eee;
    }
    .mode-switch button.active {
      background: #ffb3e6;
      font-weight: bold;
    }
    .panel {
      border-radius: 12px;
      background: #ffffff;
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: #ffc7f2;
      border: none;
    }
    button:active {
      transform: scale(0.98);
    }
    #output, #drag-word-display {
      margin-top: 10px;
      font-size: 24px;
      font-weight: bold;
      text-align: center;
    }

    /* Drag / Tap Tiles */
    .tiles-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 10px;
    }
    .tile {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: bold;
      color: #333;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s, background 0.1s;
      user-select: none;
    }
    .tile.consonant {
      background: #c7e7ff;
    }
    .tile.vowel {
      background: #ffd1d1;
    }
    .tile.active {
      background: #ffe6fd;
      box-shadow: 0 0 12px #ff80df;
    }
    .tile:active {
      transform: scale(0.9);
    }

    .blend-bar {
      margin-top: 12px;
      padding: 12px;
      min-height: 60px;
      border-radius: 12px;
      border: 2px dashed #ff9ad9;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: #fff0fb;
    }
    .blend-letter {
      font-size: 26px;
      font-weight: bold;
      padding: 4px 6px;
      border-radius: 6px;
      transition: background 0.1s, box-shadow 0.1s;
    }
    .blend-letter.active {
      background: #ffe6fd;
      box-shadow: 0 0 12px #ff80df;
    }

    .controls-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .controls-row button {
      flex: 1;
    }

    .stars {
      margin-top: 10px;
      text-align: center;
      font-size: 20px;
    }

    .small-label {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin-top: 4px;
    }

    .hidden {
      display: none;
    }

    select {
      width: 100%;
      margin-top: 6px;
    }

    .hint {
      font-size: 13px;
      text-align: center;
      color: #aa5aa0;
      margin-top: 6px;
    }
  </style>
</head>
<body>

  <h1>üåü Kiki Learns to Read üåü</h1>

  <!-- Mode Switch -->
  <div class="mode-switch">
    <button id="mode-type" class="active">Type & Blend</button>
    <button id="mode-drag">Tile Game</button>
  </div>

  <!-- TYPE & BLEND PANEL -->
  <div id="panel-type" class="panel">
    <h2>Type & Blend</h2>
    <p>Type sounds like <strong>c-a-t</strong>, then choose slow or fast blend.</p>
    <input id="phonemes" placeholder="Enter sounds e.g. c-a-t" style="width:100%; margin-top:6px;"/>
    <div class="controls-row">
      <button id="btn-type-slow">Slow Blend</button>
      <button id="btn-type-fast">Fast Blend</button>
    </div>
    <div id="output"></div>
    <p class="small-label">Uses UK synthetic phonics: s, a, t, p, i, n, etc.</p>
  </div>

  <!-- TILE GAME PANEL -->
  <div id="panel-drag" class="panel hidden">
    <h2>Tile Sound Game</h2>
    <p>Tap tiles to hear sounds. Slide your finger along the bar to blend.</p>

    <!-- Level / word selection -->
    <label for="levelSelect"><strong>Choose level:</strong></label>
    <select id="levelSelect">
      <option value="satpin">Level 1 ‚Äì s a t p i n</option>
      <option value="cvc1">Level 2 ‚Äì CVC starter words</option>
    </select>

    <div class="controls-row" style="margin-top:8px;">
      <button id="btn-new-word">New Word</button>
      <button id="btn-clear-bar">Clear Bar</button>
    </div>

    <div id="drag-word-display"></div>

    <!-- Tiles -->
    <div class="tiles-container" id="tiles-container">
      <!-- Filled by JS -->
    </div>

    <!-- Blending bar -->
    <div class="blend-bar" id="blend-bar">
      <span class="small-label">Tap tiles, then slide your finger across here</span>
    </div>
    <p class="hint">Glow will follow her finger & sounds will play in order.</p>

    <div class="controls-row">
      <button id="btn-drag-slow">Slow Blend</button>
      <button id="btn-drag-fast">Fast Blend</button>
    </div>

    <div class="stars" id="stars-display">‚≠ê Stars: <span id="stars-count">0</span></div>
    <p class="small-label">Kiki gets a star when she blends the full word!</p>
  </div>

  <script>
    // -------------------------
    // MODE SWITCHING
    // -------------------------
    const modeTypeBtn = document.getElementById("mode-type");
    const modeDragBtn = document.getElementById("mode-drag");
    const panelType = document.getElementById("panel-type");
    const panelDrag = document.getElementById("panel-drag");

    modeTypeBtn.addEventListener("click", () => {
      modeTypeBtn.classList.add("active");
      modeDragBtn.classList.remove("active");
      panelType.classList.remove("hidden");
      panelDrag.classList.add("hidden");
    });

    modeDragBtn.addEventListener("click", () => {
      modeDragBtn.classList.add("active");
      modeTypeBtn.classList.remove("active");
      panelDrag.classList.remove("hidden");
      panelType.classList.add("hidden");
    });

    // -------------------------
    // PHONICS MAP (UK synthetic phonics style)
    // -------------------------
    const phonicsMap = {
      a: "a",
      b: "b",
      c: "k",
      k: "k",
      d: "d",
      e: "e",
      f: "fff",
      g: "g",
      h: "h",
      i: "i",
      j: "j",
      l: "lll",
      m: "mmm",
      n: "nnn",
      o: "o",
      p: "p",
      q: "k",
      r: "rrr",
      s: "sss",
      t: "t",
      v: "v",
      w: "w",
      x: "ks",
      y: "y",
      z: "zzz",
      u: "u"
    };

    function toPhonicsSound(letter) {
      const key = letter.toLowerCase();
      return phonicsMap[key] || key;
    }

    // -------------------------
    // SPEECH HELPERS
    // -------------------------
    function speak(text, rate = 0.9) {
      if (!text) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = rate;
      speechSynthesis.cancel();
      speechSynthesis.speak(utter);
    }

    function speakSequence(parts, finalWord, slow = true) {
      speechSynthesis.cancel();
      let delay = 0;
      const baseDelay = slow ? 600 : 250;

      const soundParts = parts.map(p => toPhonicsSound(p));

      soundParts.forEach(sound => {
        setTimeout(() => {
          const u = new SpeechSynthesisUtterance(sound);
          u.rate = slow ? 0.7 : 1.0;
          speechSynthesis.speak(u);
        }, delay);
        delay += baseDelay;
      });

      if (finalWord) {
        setTimeout(() => {
          const uFinal = new SpeechSynthesisUtterance(finalWord);
          uFinal.rate = 0.9;
          speechSynthesis.speak(uFinal);
        }, delay + 200);
      }
    }

    function isVowel(letter) {
      return ["a","e","i","o","u"].includes(letter.toLowerCase());
    }

    // -------------------------
    // TYPE & BLEND LOGIC
    // -------------------------
    const phonemeInput = document.getElementById("phonemes");
    const btnTypeSlow = document.getElementById("btn-type-slow");
    const btnTypeFast = document.getElementById("btn-type-fast");
    const output = document.getElementById("output");

    function parsePhonemesInput() {
      const raw = phonemeInput.value.trim().toLowerCase();
      if (!raw) return { parts: [], word: "" };
      const parts = raw.replace(/\s+/g, "").split("-");
      const word = parts.join("");
      return { parts, word };
    }

    btnTypeSlow.addEventListener("click", () => {
      const { parts, word } = parsePhonemesInput();
      if (!word) {
        output.innerText = "Please enter sounds.";
        return;
      }
      output.innerText = word;
      speakSequence(parts, word, true);
    });

    btnTypeFast.addEventListener("click", () => {
      const { parts, word } = parsePhonemesInput();
      if (!word) {
        output.innerText = "Please enter sounds.";
        return;
      }
      output.innerText = word;
      speakSequence(parts, word, false);
    });

    // -------------------------
    // TILE GAME DATA (LEVELS)
    // -------------------------
    const levels = {
      satpin: {
        name: "SATPIN letters",
        words: ["sat","sit","pin","pan","tap","tin","nap"]
      },
      cvc1: {
        name: "CVC starter words",
        words: ["cat","dog","map","sun","bed","cup","lip","cap","bug"]
      }
    };

    // -------------------------
    // TILE GAME LOGIC
    // -------------------------
    const levelSelect = document.getElementById("levelSelect");
    const btnNewWord = document.getElementById("btn-new-word");
    const btnClearBar = document.getElementById("btn-clear-bar");
    const dragWordDisplay = document.getElementById("drag-word-display");
    const tilesContainer = document.getElementById("tiles-container");
    const blendBar = document.getElementById("blend-bar");
    const btnDragSlow = document.getElementById("btn-drag-slow");
    const btnDragFast = document.getElementById("btn-drag-fast");
    const starsDisplay = document.getElementById("stars-count");

    let currentWord = "";
    let stars = 0;

    function clearBlendBar() {
      blendBar.innerHTML = '<span class="small-label">Tap tiles, then slide your finger across here</span>';
    }

    function addLetterToBlendBar(letter) {
      // Remove placeholder if present
      const placeholder = blendBar.querySelector(".small-label");
      if (placeholder) placeholder.remove();

      const span = document.createElement("span");
      span.textContent = letter;
      span.classList.add("blend-letter");
      blendBar.appendChild(span);
    }

    function getBlendBarWord() {
      const letters = Array.from(blendBar.querySelectorAll(".blend-letter"));
      return letters.map(l => l.textContent).join("");
    }

    function createTilesForWord(word) {
      tilesContainer.innerHTML = "";
      const letters = word.split("");
      letters.forEach(letter => {
        const tile = document.createElement("div");
        tile.classList.add("tile");
        tile.classList.add(isVowel(letter) ? "vowel" : "consonant");
        tile.textContent = letter;
        tile.addEventListener("click", () => {
          // Tap = add to bar + play phonics sound
          addLetterToBlendBar(letter);
          tile.classList.add("active");
          setTimeout(() => tile.classList.remove("active"), 150);
          speak(toPhonicsSound(letter), 0.8);
        });
        tilesContainer.appendChild(tile);
      });
    }

    function chooseNewWord() {
      const levelKey = levelSelect.value;
      const list = levels[levelKey].words;
      const randomWord = list[Math.floor(Math.random() * list.length)];
      currentWord = randomWord;
      dragWordDisplay.textContent = currentWord.toUpperCase();
      createTilesForWord(currentWord);
      clearBlendBar();
    }

    btnNewWord.addEventListener("click", chooseNewWord);
    btnClearBar.addEventListener("click", clearBlendBar);

    btnDragSlow.addEventListener("click", () => {
      const letters = Array.from(blendBar.querySelectorAll(".blend-letter"));
      if (!letters.length) return;
      const parts = letters.map(l => l.textContent);
      const built = parts.join("");
      speakSequence(parts, built, true);
      if (built === currentWord) {
        stars++;
        starsDisplay.textContent = stars;
      }
    });

    btnDragFast.addEventListener("click", () => {
      const letters = Array.from(blendBar.querySelectorAll(".blend-letter"));
      if (!letters.length) return;
      const parts = letters.map(l => l.textContent);
      const built = parts.join("");
      speakSequence(parts, built, false);
      if (built === currentWord) {
        stars++;
        starsDisplay.textContent = stars;
      }
    });

    // -------------------------
    // FINGER SLIDE BLENDING ON BLEND BAR
    // -------------------------
    let lastActiveIndex = -1;
    let hasSlid = false;

    function clearActiveBlendLetters() {
      const letters = Array.from(blendBar.querySelectorAll(".blend-letter"));
      letters.forEach(l => l.classList.remove("active"));
    }

    function handleTouch(e) {
      const letters = Array.from(blendBar.querySelectorAll(".blend-letter"));
      if (!letters.length) return;

      e.preventDefault();
      const touch = e.touches[0];
      const x = touch.clientX;

      let activeIndex = -1;
      letters.forEach((el, idx) => {
        const rect = el.getBoundingClientRect();
        if (x >= rect.left && x <= rect.right) {
          activeIndex = idx;
        }
      });

      if (activeIndex !== -1 && activeIndex !== lastActiveIndex) {
        clearActiveBlendLetters();
        const activeLetter = letters[activeIndex];
        activeLetter.classList.add("active");
        const letterChar = activeLetter.textContent.toLowerCase();
        const sound = toPhonicsSound(letterChar);
        speak(sound, 0.8);
        lastActiveIndex = activeIndex;
        hasSlid = true;
      }
    }

    blendBar.addEventListener("touchstart", handleTouch);
    blendBar.addEventListener("touchmove", handleTouch);
    blendBar.addEventListener("touchend", () => {
      const built = getBlendBarWord();
      clearActiveBlendLetters();
      lastActiveIndex = -1;
      if (hasSlid && built) {
        // After sliding across, say full word
        speak(built, 0.9);
        if (currentWord && built === currentWord) {
          stars++;
          starsDisplay.textContent = stars;
        }
      }
      hasSlid = false;
    });

    // Initialise first word
    chooseNewWord();
  </script>

</body>
</html>
